name: Deploy to GitHub Pages

on:
  push:
    branches: [main]

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # Job 1: VÃ©rifications basiques
  check:
    name: VÃ©rifications
    runs-on: ubuntu-latest

    steps:
      - name: Checkout du code
        uses: actions/checkout@v4

      - name: VÃ©rifier que index.html existe
        run: |
          if [ -f "index.html" ]; then
            echo "âœ… index.html trouvÃ©"
          else
            echo "âŒ index.html manquant"
            exit 1
          fi

      - name: VÃ©rifier la syntaxe CSS
        run: |
          echo "ğŸ” VÃ©rification de la syntaxe CSS..."
          for file in css/*.css; do
            if [ -f "$file" ]; then
              # VÃ©rification basique: accolades Ã©quilibrÃ©es
              OPEN=$(grep -o '{' "$file" | wc -l)
              CLOSE=$(grep -o '}' "$file" | wc -l)
              if [ "$OPEN" -eq "$CLOSE" ]; then
                echo "âœ… $file - Accolades Ã©quilibrÃ©es ($OPEN/$CLOSE)"
              else
                echo "âŒ $file - Accolades dÃ©sÃ©quilibrÃ©es (ouvertes: $OPEN, fermÃ©es: $CLOSE)"
                exit 1
              fi
            fi
          done

      - name: VÃ©rifier la syntaxe JavaScript
        run: |
          echo "ğŸ” VÃ©rification de la syntaxe JavaScript..."
          for file in js/*.js; do
            if [ -f "$file" ]; then
              # VÃ©rification basique avec node
              if node -c "$file" 2>/dev/null; then
                echo "âœ… $file - Syntaxe valide"
              else
                echo "âŒ $file - Erreur de syntaxe"
                exit 1
              fi
            fi
          done

      - name: Validation HTML basique
        run: |
          echo "ğŸ” Validation HTML basique..."
          # VÃ©rifier les balises ouvrantes/fermantes courantes
          for tag in html head body div section header footer nav main article; do
            OPEN=$(grep -o "<$tag" index.html | wc -l)
            CLOSE=$(grep -o "</$tag>" index.html | wc -l)
            if [ "$OPEN" -eq "$CLOSE" ]; then
              echo "âœ… Balise <$tag>: Ã©quilibrÃ©e ($OPEN/$CLOSE)"
            else
              echo "âš ï¸  Balise <$tag>: possiblement dÃ©sÃ©quilibrÃ©e (ouvertes: $OPEN, fermÃ©es: $CLOSE)"
            fi
          done

          # VÃ©rifier que le HTML se termine correctement
          if grep -q "</html>" index.html; then
            echo "âœ… Balise </html> de fermeture trouvÃ©e"
          else
            echo "âŒ Balise </html> de fermeture manquante"
            exit 1
          fi

      - name: RÃ©sumÃ© des vÃ©rifications
        run: |
          echo "âœ… Toutes les vÃ©rifications sont passÃ©es !"
          echo "ğŸ“¦ PrÃªt pour le dÃ©ploiement"

  # Job 2: DÃ©ploiement
  deploy:
    name: DÃ©ploiement
    needs: check
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Checkout du code
        uses: actions/checkout@v4

      - name: Configuration GitHub Pages
        uses: actions/configure-pages@v4

      - name: Upload des fichiers
        uses: actions/upload-pages-artifact@v3
        with:
          path: '.'

      - name: DÃ©ploiement sur GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Confirmation du dÃ©ploiement
        run: |
          echo "ğŸš€ Site dÃ©ployÃ© avec succÃ¨s !"
          echo "ğŸŒ URL: ${{ steps.deployment.outputs.page_url }}"
