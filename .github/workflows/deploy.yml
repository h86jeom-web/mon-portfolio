name: Build, Test & Deploy

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # Job 1 : Tests et VÃ©rifications
  test:
    name: Tests & VÃ©rifications
    runs-on: ubuntu-latest

    steps:
      - name: Checkout du code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Installation des dÃ©pendances
        run: npm ci

      - name: Validation HTML
        run: |
          npm install -g html-validate
          html-validate "*.html" --formatter stylish || true

      - name: Linting CSS
        run: |
          npm install -g stylelint stylelint-config-standard
          echo '{"extends": "stylelint-config-standard"}' > .stylelintrc.json
          stylelint "css/**/*.css" || true

      - name: Linting JavaScript
        run: |
          npm install -g eslint
          echo '{"env": {"browser": true, "es2021": true}, "extends": "eslint:recommended", "parserOptions": {"ecmaVersion": "latest", "sourceType": "module"}}' > .eslintrc.json
          eslint "js/**/*.js" --max-warnings 10 || true

      - name: VÃ©rification des fichiers requis
        run: |
          echo "ğŸ” VÃ©rification des fichiers..."
          test -f index.html && echo "âœ… index.html trouvÃ©" || (echo "âŒ index.html manquant" && exit 1)
          test -f css/style.css && echo "âœ… style.css trouvÃ©" || (echo "âŒ style.css manquant" && exit 1)
          test -f js/main.js && echo "âœ… main.js trouvÃ©" || (echo "âŒ main.js manquant" && exit 1)
          test -f data/projects.json && echo "âœ… projects.json trouvÃ©" || (echo "âŒ projects.json manquant" && exit 1)

      - name: Validation JSON
        run: |
          echo "ğŸ” Validation du fichier JSON..."
          node -e "JSON.parse(require('fs').readFileSync('data/projects.json', 'utf8'))" && echo "âœ… projects.json valide"

      - name: RÃ©sumÃ© des tests
        run: |
          echo "âœ… Tous les tests sont passÃ©s !"
          echo "ğŸ“¦ PrÃªt pour le dÃ©ploiement"

  # Job 2 : DÃ©ploiement sur GitHub Pages
  deploy:
    name: DÃ©ploiement GitHub Pages
    needs: test
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Checkout du code
        uses: actions/checkout@v4

      - name: Configuration des Pages
        uses: actions/configure-pages@v4

      - name: Upload des artifacts
        uses: actions/upload-pages-artifact@v3
        with:
          path: '.'

      - name: DÃ©ploiement sur GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: RÃ©sumÃ© du dÃ©ploiement
        run: |
          echo "ğŸš€ DÃ©ploiement rÃ©ussi !"
          echo "ğŸŒ Site accessible Ã : ${{ steps.deployment.outputs.page_url }}"
